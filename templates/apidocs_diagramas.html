<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Simulación de Flujos - API K-I-B-O</title>

  <link rel="stylesheet" href="{{ url_for('static', filename='apidocs.css') }}" />
  <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/svg-pan-zoom@3.6.1/dist/svg-pan-zoom.min.js"></script>

  <style>
    .edgeLabel {
      background-color: #0f172a !important;
      color: #38bdf8 !important;
      border: 1px solid #1e40af;
      border-radius: 12px;
      padding: 4px 10px;
      font-family: 'Arial', sans-serif;
      font-size: 11px;
      font-weight: bold;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
      z-index: 10;
    }

    .sim-controls {
      display: flex;
      gap: 10px;
      margin-right: 20px;
    }

    .sim-btn {
      padding: 6px 12px;
      border: none;
      border-radius: 6px;
      font-size: 0.85rem;
      font-weight: 600;
      cursor: pointer;
      color: white;
      transition: transform 0.2s, opacity 0.2s;
    }

    .sim-btn:hover {
      transform: translateY(-2px);
      opacity: 0.9;
    }

    .sim-btn:active {
      transform: translateY(0);
    }

    .btn-case-1 {
      background-color: #ec407a;
      box-shadow: 0 4px 10px rgba(236, 64, 122, 0.3);
    }

    .btn-case-2 {
      background-color: #2196F3;
      box-shadow: 0 4px 10px rgba(33, 150, 243, 0.3);
    }

    .btn-case-3 {
      background-color: #ff9800;
      box-shadow: 0 4px 10px rgba(255, 152, 0, 0.3);
    }

  </style>

  <script>
    document.addEventListener('DOMContentLoaded', function () {

      mermaid.initialize({
        startOnLoad: false,
        theme: "base",
        securityLevel: "loose",
        themeVariables: {
          primaryColor: "#0b3b60",
          primaryTextColor: "#ffffff",
          primaryBorderColor: "#42a5f5",
          lineColor: "#90caf9",
          secondaryColor: "#00695c",
          tertiaryColor: "#020817",
          edgeLabelBackground: "#0f172a",
          tertiaryTextColor: "#38bdf8"
        },
      });

      function activarZoomEnDiagramas() {
        document.querySelectorAll('.mermaid svg').forEach(function (svg) {
          if (svg.getAttribute('data-panzoom-init') === '1') return;
          var panZoom = svgPanZoom(svg, {
            zoomEnabled: true, controlIconsEnabled: false, fit: true, center: true, minZoom: 0.2, maxZoom: 5, contain: true
          });
          panZoom.resize(); panZoom.fit(); panZoom.center();
          svg.setAttribute('data-panzoom-init', '1');
        });
      }

      function initFullscreenModal() {
        const backdrop = document.getElementById('diagram-modal-backdrop');
        const bodyWrap = document.getElementById('diagram-modal-svg-wrap');
        const closeBtn = document.getElementById('diagram-modal-close');
        const headerActions = document.getElementById('modal-header-actions');
        let panZoomInstance = null;
        let activeTimeouts = [];


        function limpiarEstilos(svgRoot) {
          if (!svgRoot) return;
          svgRoot.querySelectorAll('.kibo-demo-highlight, .kibo-demo-pulse').forEach(el =>
            el.classList.remove('kibo-demo-highlight', 'kibo-demo-pulse')
          );
          svgRoot.querySelectorAll('.kibo-demo-label').forEach(el => el.remove());
        }

        function resetearSimulacion(svgRoot) {
          activeTimeouts.forEach(t => clearTimeout(t));
          activeTimeouts = [];
          limpiarEstilos(svgRoot);
        }

        function crearLabel(svgRoot, targetBBox, texto) {
          if (!svgRoot || !targetBBox) return;
          const ns = 'http://www.w3.org/2000/svg';
          const g = document.createElementNS(ns, 'g'); g.setAttribute('class', 'kibo-demo-label');
          const x = targetBBox.x + targetBBox.width / 2;
          const y = targetBBox.y - 20;

          const rect = document.createElementNS(ns, 'rect');
          rect.setAttribute('rx', '8'); rect.setAttribute('ry', '8');
          rect.setAttribute('fill', 'rgba(15, 23, 42, 0.95)');
          rect.setAttribute('stroke', '#38bdf8'); rect.setAttribute('stroke-width', '2');

          const text = document.createElementNS(ns, 'text');
          text.setAttribute('fill', '#e0f2fe'); text.setAttribute('font-size', '14');
          text.setAttribute('font-weight', 'bold'); text.setAttribute('text-anchor', 'middle');
          text.setAttribute('x', x); text.setAttribute('y', y + 5);
          text.textContent = texto;

          svgRoot.appendChild(text);
          const bbox = text.getBBox();
          rect.setAttribute('x', bbox.x - 12); rect.setAttribute('y', bbox.y - 8);
          rect.setAttribute('width', bbox.width + 24); rect.setAttribute('height', bbox.height + 16);
          g.appendChild(rect); g.appendChild(text); svgRoot.appendChild(g);
        }

        function resaltar(svgRoot, id, texto, pulse = true) {
          const matches = Array.from(svgRoot.querySelectorAll('[id*="' + id + '"]'));
          const node = matches.find(el => el.classList.contains('node') || el.closest('.node'));
          if (!node) return;

          const group = node.closest('.node') || node;
          group.classList.add('kibo-demo-highlight');
          if (pulse) group.classList.add('kibo-demo-pulse');

          if (texto) {
            const shape = group.querySelector('rect, polygon, circle, path') || group;
            const bbox = shape.getBBox ? shape.getBBox() : null;
            if (bbox) crearLabel(svgRoot, bbox, texto);
          }
        }

        function ejecutarSimulacion(caso) {
          const svgRoot = bodyWrap.querySelector('svg');
          if (!svgRoot) return;

          resetearSimulacion(svgRoot);
          console.log("Ejecutando Caso:", caso);

          resaltar(svgRoot, 'U', 'Usuario envía mensaje', true);

          activeTimeouts.push(setTimeout(() => {
            limpiarEstilos(svgRoot);
            resaltar(svgRoot, 'I', 'API recibe', true);
          }, 1500));

          activeTimeouts.push(setTimeout(() => {
            limpiarEstilos(svgRoot);
            resaltar(svgRoot, 'V', 'Validación OK', true);
          }, 3000));

          if (caso === 1) {
            activeTimeouts.push(setTimeout(() => {
              limpiarEstilos(svgRoot);
              resaltar(svgRoot, 'N', '¡Intención Detectada!', true);
            }, 4500));

            activeTimeouts.push(setTimeout(() => {
              limpiarEstilos(svgRoot);
              resaltar(svgRoot, 'C', 'Consultando NLP...', true);
            }, 6000));

            activeTimeouts.push(setTimeout(() => {
              limpiarEstilos(svgRoot);
              resaltar(svgRoot, 'L', 'Respuesta Generada', true);
            }, 7500));

          } else {
            activeTimeouts.push(setTimeout(() => {
              limpiarEstilos(svgRoot);
              resaltar(svgRoot, 'N', 'Intención Desconocida', true);
            }, 4500));

            activeTimeouts.push(setTimeout(() => {
              limpiarEstilos(svgRoot);
              resaltar(svgRoot, 'DB_Check', 'Buscando en Base de Datos...', true);
            }, 6000));

            if (caso === 2) {
              activeTimeouts.push(setTimeout(() => {
                limpiarEstilos(svgRoot);
                resaltar(svgRoot, 'DB_Resp', '¡Similitud Encontrada!', true);
              }, 8000));
            } else {
              activeTimeouts.push(setTimeout(() => {
                limpiarEstilos(svgRoot);
                resaltar(svgRoot, 'H', 'Sin datos -> Búsqueda Híbrida', true);
              }, 8000));
            }
          }

          const tiempoFinal = caso === 1 ? 9000 : 10000;
          activeTimeouts.push(setTimeout(() => {
            limpiarEstilos(svgRoot);
            resaltar(svgRoot, 'R', 'Enviando al Usuario', true);
          }, tiempoFinal));

          activeTimeouts.push(setTimeout(() => {
            limpiarEstilos(svgRoot);
          }, tiempoFinal + 2000));
        }

        function openFrom(sourceMermaid) {
          bodyWrap.innerHTML = '';
          const srcSvg = sourceMermaid.querySelector('svg');
          if (!srcSvg) return;

          const clone = srcSvg.cloneNode(true);
          clone.removeAttribute('data-panzoom-init');
          clone.style.cssText = "width: 100%; height: 100%; display: block;";
          bodyWrap.appendChild(clone);

          const isDiagram1 = sourceMermaid.id === 'diagram1-mermaid';

          if (isDiagram1) {
            headerActions.innerHTML = `
                <div class="sim-controls">
                    <button class="sim-btn btn-case-1" onclick="window.runSim(1)">Caso 1: NLP</button>
                    <button class="sim-btn btn-case-2" onclick="window.runSim(2)">Caso 2: BD</button>
                    <button class="sim-btn btn-case-3" onclick="window.runSim(3)">Caso 3: Híbrida</button>
                </div>
            `;
            window.runSim = ejecutarSimulacion;
          } else {
            headerActions.innerHTML = '';
          }

          backdrop.classList.add('diagram-modal-backdrop--visible');
          setTimeout(() => {
            panZoomInstance = svgPanZoom(clone, {
              zoomEnabled: true, controlIconsEnabled: true, fit: true, center: true, minZoom: 0.2, maxZoom: 10
            });
          }, 100);
        }

        function close() {
          if (panZoomInstance) { panZoomInstance.destroy(); panZoomInstance = null; }
          backdrop.classList.remove('diagram-modal-backdrop--visible');
          bodyWrap.innerHTML = '';
          activeTimeouts.forEach(t => clearTimeout(t));
          activeTimeouts = [];
        }

        closeBtn.addEventListener('click', close);
        backdrop.addEventListener('click', (e) => { if (e.target === backdrop) close() });
        document.addEventListener('keydown', (e) => { if (e.key === 'Escape') close() });

        document.querySelectorAll('[data-diagram-fullscreen-target]').forEach(btn =>
          btn.addEventListener('click', () => {
            const el = document.getElementById(btn.getAttribute('data-diagram-fullscreen-target'));
            if (el) openFrom(el);
          })
        );
      }

      mermaid.run({ querySelector: '.mermaid' }).then(() => {
        activarZoomEnDiagramas();
        setTimeout(() => {
          document.querySelectorAll('.mermaid').forEach(el => {
            el.classList.remove('mermaid-init-hidden');
            el.classList.add('mermaid-init-visible');
          });
        }, 100);
        initFullscreenModal();
      });
    });
  </script>
</head>

<body class="apidocs-diagramas-page">
  <header class="topbar">
    <a href="/apidocs" class="top-link-button">← Volver a Documentación</a>
    <div class="topbar-title-wrap">
      <span class="hola-text">Arquitectura del Sistema K-I-B-O</span>
    </div>
  </header>

  <main class="diagramas-main">

    <section class="diagram-card">
      <header class="diagram-card__header">
        <h2>Flujo de Decisión NLP y Fallback</h2>
        <p>Abre el visualizador para simular los 3 casos de uso (NLP, BD, Híbrida).</p>
      </header>
      <div class="diagram-card__actions">
        <button class="diagram-card__fullscreen-btn" data-diagram-fullscreen-target="diagram1-mermaid">
          ⤢ Abrir Simulador
        </button>
      </div>
      <div class="diagram-card__body">
        <div class="mermaid mermaid-init-hidden" id="diagram1-mermaid">
          %%{init: {
          'flowchart': {
          'curve': 'monotoneY',
          'nodeSpacing': 120,
          'rankSpacing': 90
          },
          'theme': 'base',
          'themeVariables': {
          'primaryColor': '#0b3b60',
          'edgeLabelBackground': '#0f172a',
          'tertiaryTextColor': '#38bdf8'
          }
          }}%%
          flowchart TD
          %% --- ESTILOS ---
          classDef startNode fill:#00c853,stroke:#009624,stroke-width:2px,color:#fff,rx:5,ry:5,font-weight:bold;
          classDef processNode fill:#0b3b60,stroke:#2196F3,stroke-width:2px,color:#fff,rx:5,ry:5;
          classDef decisionNode fill:#0d1b2a,stroke:#4fc3f7,stroke-width:2px,color:#fff,shape:diamond;
          classDef pinkNode fill:#ad1457,stroke:#ec407a,stroke-width:2px,color:#fff,rx:5,ry:5;
          classDef orangeNode fill:#e65100,stroke:#ff9800,stroke-width:2px,color:#fff,rx:5,ry:5;
          classDef endNode fill:#cfd8dc,stroke:#90a4ae,stroke-width:2px,color:#000,rx:5,ry:5,font-weight:bold;

          %% --- NODOS ---
          U(Usuario):::startNode
          I[Interfaz / API]:::processNode
          V{Validación}:::decisionNode

          %% Nivel 1
          N{¿Intención<br>Reconocida?}:::decisionNode

          %% RAMA SÍ (NLP)
          C[Motor NLP<br>Específico]:::pinkNode
          L[Generar<br>Respuesta]:::pinkNode

          %% RAMA NO (BD Check)
          DB_Check{¿Similitud<br>en BD?}:::decisionNode

          %% Resultado BD
          DB_Resp[Respuesta<br>Exacta BD]:::processNode

          %% Fallback (Híbrida)
          H[Búsqueda<br>Híbrida / IA]:::orangeNode

          %% FINAL
          R(Enviar al Usuario):::endNode

          %% --- CONEXIONES ---
          U -->|Mensaje| I
          I --> V
          V -->|Error| R
          linkStyle 2 stroke:#546e7a,stroke-width:1px,stroke-dasharray: 5 5;

          V -->|Ok| N

          %% Camino Rosa (NLP)
          N -->|SÍ| C
          linkStyle 4 stroke:#ec407a,stroke-width:3px;
          C --> L --> R

          %% Camino Fallback (Azul -> Naranja)
          N -->|NO| DB_Check
          linkStyle 7 stroke:#2196F3,stroke-width:3px;

          %% Base de Datos
          DB_Check -->|ENCONTRADO| DB_Resp
          DB_Resp --> R

          %% Híbrida
          DB_Check -->|NO ENCONTRADO| H
          linkStyle 10 stroke:#ff9800,stroke-width:3px;
          H --> R
        </div>
      </div>
    </section>

    <section class="diagram-card">
      <header class="diagram-card__header">
        <h2>Ciclo de Vida de Datos</h2>
        <p>Interacción con Firebase Auth y Firestore.</p>
      </header>
      <div class="diagram-card__actions">
        <button class="diagram-card__fullscreen-btn" data-diagram-fullscreen-target="diagram2-mermaid">
          ⤢ Pantalla completa
        </button>
      </div>
      <div class="diagram-card__body">
        <div class="mermaid mermaid-init-hidden" id="diagram2-mermaid">
          sequenceDiagram
          participant U as Usuario
          participant B as API Flask
          participant FB as Firebase

          U->>B: POST /api/get_bot_response
          B->>FB: Autenticación (Admin SDK)

          alt Servicio Disponible
          B->>FB: Guardar Input (Logs)
          B->>B: Clasificar (Joblib/NLTK)
          B->>FB: Consultar Respuestas
          B->>FB: Guardar Output (Historial)
          B-->>U: JSON { status: success }
          else Error
          B-->>U: JSON { error: 500 }
          end
        </div>
      </div>
    </section>
  </main>

  <div class="diagram-modal-backdrop" id="diagram-modal-backdrop">
    <div class="diagram-modal">
      <div class="diagram-modal__header">
        <span class="diagram-modal__title">Visualizador Interactivo</span>
        <div id="modal-header-actions"></div>
        <button id="diagram-modal-close" class="diagram-modal__close">×</button>
      </div>
      <div class="diagram-modal__body">
        <div class="diagram-modal__svg-wrap" id="diagram-modal-svg-wrap"></div>
      </div>
    </div>
  </div>
</body>

</html>